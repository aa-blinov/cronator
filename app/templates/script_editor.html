{% extends "base.html" %}
{% import "icons.html" as icons %}

{% block header_actions %}
{% if script and script.git_commit %}
<div class="badge badge-info badge-lg gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.28 1.15-.28 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
    Managed by Git
</div>
{% endif %}
<a href="{% if script %}/scripts/{{ script.id }}{% else %}/{% endif %}" class="btn btn-ghost btn-sm">Cancel</a>
{% endblock %}

{% block extra_head %}
<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-ocean.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<style>
    .CodeMirror {
        height: 500px;
        font-size: 14px;
        border-radius: 0.5rem;
    }
    
    /* Custom scrollbar styling */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.5);
    }
    
    /* For Firefox */
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1);
    }
    
    /* Dependency diff styles */
    .diff-line-added {
        background-color: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
        border-left: 2px solid rgb(34, 197, 94);
        padding-left: 0.5rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }
    
    .diff-line-removed {
        background-color: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
        border-left: 2px solid rgb(239, 68, 68);
        padding-left: 0.5rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }
    
    .diff-line-modified {
        background-color: rgba(251, 191, 36, 0.1);
        color: rgb(251, 191, 36);
        border-left: 2px solid rgb(251, 191, 36);
        padding-left: 0.5rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }
    
    .diff-line-added::before {
        content: '+ ';
        font-weight: bold;
    }
    
    .diff-line-removed::before {
        content: '- ';
        font-weight: bold;
    }
    
    .diff-line-modified::before {
        content: '~ ';
        font-weight: bold;
    }
    
    /* Hide collapse checkbox */
    #deps-diff-container input[type="checkbox"] {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" action="{% if script %}/api/scripts/{{ script.id }}{% else %}/api/scripts{% endif %}" id="script-form" data-script-id="{% if script %}{{ script.id }}{% endif %}">
    
    {% if script and script.git_commit %}
    <div class="alert alert-warning shadow-lg mb-6">
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <span><b>Warning:</b> This script is managed by Git. Local changes made here will be overwritten during the next Git sync.</span>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main editor -->
        <div class="lg:col-span-2 space-y-6">
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Script Code</h3>
                    <div class="flex gap-2">
                        <button type="button" id="validate-btn" class="btn btn-outline btn-info btn-sm gap-2">
                            {{ icons.check_circle("w-4 h-4") }}
                            Validate
                        </button>
                        <button type="button" id="run-test-btn" class="btn btn-outline btn-success btn-sm gap-2">
                            {{ icons.play("w-4 h-4") }}
                            Run Test
                        </button>
                        <button type="button" id="stop-test-btn" class="btn btn-outline btn-error btn-sm gap-2" style="display: none;">
                            {{ icons.x_mark("w-4 h-4") }}
                            Stop Test
                        </button>
                    </div>
                </div>
                <textarea id="code-editor" name="content">{{ content }}</textarea>
            </div>
            
            <!-- Output Console -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <h3 class="text-lg font-semibold">Output Console</h3>
                        <span id="console-status" class="badge badge-ghost">Idle</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="label cursor-pointer gap-2 py-0">
                            <span class="label-text text-xs">Auto-scroll</span>
                            <input type="checkbox" id="auto-scroll-toggle" class="toggle toggle-xs" checked>
                        </label>
                        <button type="button" id="reconnect-btn" class="btn btn-outline btn-warning btn-xs" style="display: none;">
                            Reconnect
                        </button>
                        <button type="button" id="copy-output-btn" class="btn btn-outline btn-xs">
                            Copy
                        </button>
                        <button type="button" id="download-output-btn" class="btn btn-outline btn-xs">
                            Download
                        </button>
                        <button type="button" id="clear-output-btn" class="btn btn-outline btn-xs">
                            Clear
                        </button>
                    </div>
                </div>
                <pre id="output-console" class="bg-base-200 p-4 rounded-lg font-mono text-sm overflow-y-auto custom-scrollbar" style="resize: vertical; min-height: 200px; max-height: 600px; height: 300px;"></pre>
            </div>
        </div>
        
        <!-- Settings sidebar -->
        <div class="space-y-6">
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">Settings</h3>
                
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Script Name</span>
                        </label>
                        <input type="text" name="name" 
                               value="{{ script.name if script else '' }}"
                               placeholder="my-script"
                               class="input input-bordered w-full"
                               pattern="[a-zA-Z0-9_\-]+"
                               required
                               {% if script %}readonly{% endif %}>
                        <label class="label">
                            <span class="label-text-alt text-gray-500">Letters, numbers, underscores, hyphens only</span>
                        </label>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Script Description</span>
                        </label>
                        <textarea name="description" 
                                  class="textarea textarea-bordered w-full"
                                  rows="2"
                                  placeholder="What does this script do? (general purpose, stays unchanged)">{{ script.description if script else '' }}</textarea>
                        <label class="label">
                            <span class="label-text-alt text-gray-500">Permanent description of the script's purpose</span>
                        </label>
                    </div>
                    
                    {% if script %}
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Version Notes (optional)</span>
                        </label>
                        <textarea name="change_summary" id="change-summary" rows="2" 
                                  class="textarea textarea-bordered w-full text-sm"
                                  placeholder="e.g., Fixed bug with data parsing, Updated dependencies, Added new feature..."></textarea>
                        <label class="label">
                            <span class="label-text-alt text-gray-500">Describe what you changed in this save. Visible in version history.</span>
                        </label>
                    </div>
                    {% endif %}
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Cron Expression</span>
                        </label>
                        <input type="text" name="cron_expression" 
                               value="{{ script.cron_expression if script else '0 * * * *' }}"
                               placeholder="0 * * * *"
                               class="input input-bordered w-full font-mono"
                               required>
                        <label class="label">
                            <span class="label-text-alt text-gray-500">minute hour day month weekday</span>
                        </label>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Python Version</span>
                        </label>
                        <select name="python_version" class="select select-bordered w-full">
                            {% for ver in python_versions %}
                            <option value="{{ ver }}" {% if script and script.python_version == ver %}selected{% elif not script and ver == '3.11' %}selected{% endif %}>
                                Python {{ ver }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Timeout (seconds)</span>
                        </label>
                        <input type="number" name="timeout" 
                               value="{{ script.timeout if script else 3600 }}"
                               min="1" max="86400"
                               class="input input-bordered w-full">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Misfire Grace Time (seconds)</span>
                        </label>
                        <input type="number" name="misfire_grace_time" 
                               value="{{ script.misfire_grace_time if script else 60 }}"
                               min="0" max="3600"
                               class="input input-bordered w-full">
                        <label class="label">
                            <span class="label-text-alt text-gray-500">Wait time for missed runs</span>
                        </label>
                    </div>
                    
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Enabled</span>
                            <input type="checkbox" name="enabled" value="true"
                                   class="toggle toggle-primary"
                                   {% if not script or script.enabled %}checked{% endif %}>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">Dependencies</h3>
                <div class="form-control">
                    <textarea name="dependencies" id="dependencies-input"
                              class="textarea textarea-bordered w-full font-mono text-sm"
                              rows="6"
                              placeholder="requests&#10;pandas&#10;numpy==1.24.0">{{ script.dependencies if script else '' }}</textarea>
                    <label class="label">
                        <span class="label-text-alt text-gray-500">One package per line (pip format)</span>
                    </label>
                </div>
                
                <!-- Inline Diff Container -->
                <div id="deps-diff-container" class="collapse collapse-arrow bg-base-200 rounded-lg mt-2" style="display: none;">
                    <input type="checkbox" id="deps-diff-toggle" />
                    <div class="collapse-title text-sm font-medium flex items-center justify-between pr-4">
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Pending Changes
                        </span>
                        <span id="deps-diff-badge" class="badge badge-warning badge-sm">0</span>
                    </div>
                    <div class="collapse-content text-xs font-mono">
                        <div class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar">
                            <div id="deps-diff-added" class="space-y-1"></div>
                            <div id="deps-diff-removed" class="space-y-1"></div>
                            <div id="deps-diff-modified" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 flex gap-2">
                    <button type="button" id="validate-deps-btn" class="btn btn-sm btn-outline btn-info flex-1" title="Validate format and resolvability">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Validate
                    </button>
                    <button type="button" id="get-packages-btn" class="btn btn-sm btn-outline btn-warning flex-1" {% if not script %}disabled{% endif %} title="Get currently installed packages">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                        Packages
                    </button>
                    <button type="button" id="install-deps-btn" class="btn btn-sm btn-outline btn-success flex-1" {% if not script %}disabled{% endif %} title="{% if not script %}Save script first{% else %}Rebuild environment and reinstall all dependencies{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Install
                    </button>
                    <button type="button" id="retry-install-btn" class="btn btn-sm btn-outline btn-warning" {% if not script %}disabled{% endif %} style="display: none;" title="Retry the last failed installation">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>
                </div>
                <!-- Validation results now go to Output Console below -->
                <div class="alert alert-info mt-3 text-xs py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Dependencies install automatically when you save. Use "Install" to force rebuild.</span>
                </div>
            </div>

            <!-- Version History -->
            {% if script %}
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Version History
                    </h3>
                    <span id="version-count-badge" class="badge badge-info badge-sm">0</span>
                </div>
                <div id="versions-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                    <div class="text-sm text-gray-500 italic">Loading versions...</div>
                </div>
            </div>
            {% endif %}
            
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">Alerts</h3>
                <div class="space-y-2">
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Alert on failure</span>
                            <input type="checkbox" name="alert_on_failure" value="true"
                                   class="toggle toggle-error"
                                   {% if not script or script.alert_on_failure %}checked{% endif %}>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label cursor-pointer">
                            <span class="label-text">Alert on success</span>
                            <input type="checkbox" name="alert_on_success" value="true"
                                   class="toggle toggle-success"
                                   {% if script and script.alert_on_success %}checked{% endif %}>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">Environment Variables</h3>
                <div class="form-control">
                    <textarea name="environment_vars" 
                              class="textarea textarea-bordered w-full font-mono text-sm"
                              rows="4"
                              placeholder="API_KEY=secret&#10;DEBUG=true">{{ script.environment_vars if script else '' }}</textarea>
                    <label class="label">
                        <span class="label-text-alt text-gray-500">KEY=VALUE format, one per line</span>
                    </label>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button type="submit" class="btn btn-primary flex-1">
                    {{ icons.check_circle("w-5 h-5") }} {% if script %}Save Changes{% else %}Create Script{% endif %}
                </button>
                <a href="{% if script %}/scripts/{{ script.id }}{% else %}/{% endif %}" class="btn btn-ghost">
                    Cancel
                </a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    // Script ID for API calls (read from form data attribute)
    const scriptForm = document.getElementById('script-form');
    const scriptId = scriptForm ? (scriptForm.dataset.scriptId || null) : null;
    
    // Initialize CodeMirror
    const textarea = document.getElementById('code-editor');
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'material-ocean',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
    });
    
    // === INLINE DIFF LOGIC ===
    let originalDeps = {{ (script.dependencies if script else "") | tojson }};
    let diffTimeout = null;
    let lastInstallFailed = false;

    const depsInput = document.getElementById('dependencies-input');
    const diffContainer = document.getElementById('deps-diff-container');
    const diffToggle = document.getElementById('deps-diff-toggle');
    const diffBadge = document.getElementById('deps-diff-badge');
    const diffAdded = document.getElementById('deps-diff-added');
    const diffRemoved = document.getElementById('deps-diff-removed');
    const diffModified = document.getElementById('deps-diff-modified');
    const retryBtn = document.getElementById('retry-install-btn');

    // Parse dependencies into array of {name, version, raw}
    function parseDependencies(depsText) {
        return depsText.split('\\n')
            .map(line => line.trim())
            .filter(line => line && !line.startsWith('#'))
            .map(line => {
                // Match package name and optional version specifier
                const match = line.match(/^([a-zA-Z0-9_.-]+)([>=<~!].*)?$/);
                if (!match) return { name: line, version: '', raw: line, invalid: true };
                return { 
                    name: match[1].toLowerCase().replace(/_/g, '-'),
                    version: match[2] || '', 
                    raw: line 
                };
            });
    }

    // Compute diff between old and new dependencies
    function computeDiff(oldText, newText) {
        const oldDeps = parseDependencies(oldText);
        const newDeps = parseDependencies(newText);
        
        const oldMap = new Map(oldDeps.map(d => [d.name, d]));
        const newMap = new Map(newDeps.map(d => [d.name, d]));
        
        const added = [];
        const removed = [];
        const modified = [];
        
        // Check for added and modified
        for (const [name, newDep] of newMap) {
            if (!oldMap.has(name)) {
                added.push(newDep.raw);
            } else if (oldMap.get(name).version !== newDep.version) {
                modified.push({
                    name: newDep.name,
                    old: oldMap.get(name).raw,
                    new: newDep.raw
                });
            }
        }
        
        // Check for removed
        for (const [name, oldDep] of oldMap) {
            if (!newMap.has(name)) {
                removed.push(oldDep.raw);
            }
        }
        
        return { added, removed, modified };
    }

    // Render diff in UI
    function renderDiff(diff) {
        const totalChanges = diff.added.length + diff.removed.length + diff.modified.length;
        
        if (totalChanges === 0) {
            diffContainer.style.display = 'none';
            return;
        }
        
        // Show container
        diffContainer.style.display = 'block';
        diffBadge.textContent = totalChanges;
        
        // Clear previous diff
        diffAdded.innerHTML = '';
        diffRemoved.innerHTML = '';
        diffModified.innerHTML = '';
        
        // Render added
        if (diff.added.length > 0) {
            diff.added.forEach(pkg => {
                const div = document.createElement('div');
                div.className = 'diff-line-added';
                div.textContent = pkg;
                diffAdded.appendChild(div);
            });
        }
        
        // Render removed
        if (diff.removed.length > 0) {
            diff.removed.forEach(pkg => {
                const div = document.createElement('div');
                div.className = 'diff-line-removed';
                div.textContent = pkg;
                diffRemoved.appendChild(div);
            });
        }
        
        // Render modified (show old → new)
        if (diff.modified.length > 0) {
            diff.modified.forEach(change => {
                const div = document.createElement('div');
                div.className = 'diff-line-modified';
                const oldSpan = document.createElement('span');
                oldSpan.style.textDecoration = 'line-through';
                oldSpan.style.opacity = '0.6';
                oldSpan.textContent = change.old;
                div.appendChild(oldSpan);
                div.appendChild(document.createTextNode(' → ' + change.new));
                diffModified.appendChild(div);
            });
        }
        
        // Auto-expand on first change
        if (!diffToggle.checked && totalChanges > 0) {
            diffToggle.checked = true;
        }
    }

    // Handle input with debounce
    depsInput.addEventListener('input', () => {
        clearTimeout(diffTimeout);
        diffTimeout = setTimeout(() => {
            const currentDeps = depsInput.value;
            const diff = computeDiff(originalDeps, currentDeps);
            renderDiff(diff);
        }, 500);
    });
    
    // Make collapse title clickable
    const diffCollapseTitle = diffContainer?.querySelector('.collapse-title');
    if (diffCollapseTitle) {
        diffCollapseTitle.style.cursor = 'pointer';
        diffCollapseTitle.addEventListener('click', () => {
            if (diffToggle) {
                diffToggle.checked = !diffToggle.checked;
            }
        });
    }

    // === RETRY BUTTON LOGIC ===
    retryBtn.addEventListener('click', () => {
        if (lastInstallFailed) {
            // Trigger install button click
            document.getElementById('install-deps-btn').click();
        }
    });
    
    // Update dependency buttons state based on input
    function updateDependencyButtonsState() {
        const depsInput = document.getElementById('dependencies-input');
        const validateBtn = document.getElementById('validate-deps-btn');
        const installBtn = document.getElementById('install-deps-btn');
        const getPackagesBtn = document.getElementById('get-packages-btn');
        const hasDeps = depsInput.value.trim().length > 0;
        
        validateBtn.disabled = !hasDeps;
        
        // Install and Packages buttons are disabled if no script exists OR no dependencies
        if (installBtn) {
            installBtn.disabled = !scriptId || !hasDeps;
        }
        if (getPackagesBtn) {
            getPackagesBtn.disabled = !scriptId;
        }
    }
    
    // Initialize button states and add input listener
    document.addEventListener('DOMContentLoaded', () => {
        updateDependencyButtonsState();
        document.getElementById('dependencies-input').addEventListener('input', updateDependencyButtonsState);
    });
    
    // Validate dependencies
    document.getElementById('validate-deps-btn').addEventListener('click', async () => {
        const depsInput = document.getElementById('dependencies-input');
        const validateBtn = document.getElementById('validate-deps-btn');
        
        const dependencies = depsInput.value;
        
        if (!dependencies.trim()) {
            appendBlockToConsole('Validation', 'No dependencies to validate', 'info');
            return;
        }
        
        // Show loading state
        validateBtn.disabled = true;
        validateBtn.innerHTML = `
            <span class="loading loading-spinner loading-xs"></span>
            Validating...
        `;
        
        try {
            const response = await fetch('/api/scripts/validate-dependencies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ dependencies }),
            });
            
            const result = await response.json();
            
            if (result.valid) {
                const content = `Dependencies are valid!
Message: ${result.message}
Packages: ${result.packages.join(', ')}`;
                appendBlockToConsole('Validation Success', content, 'success');
            } else {
                appendBlockToConsole('Validation Error', result.message, 'error');
            }
            
        } catch (err) {
            appendBlockToConsole('Validation Error', `Failed to validate: ${err.message}`, 'error');
        } finally {
            // Reset button state
            validateBtn.disabled = false;
            validateBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Validate
            `;
        }
    });

    // Get currently installed packages
    const getPackagesBtn = document.getElementById('get-packages-btn');
    if (getPackagesBtn) {
        getPackagesBtn.addEventListener('click', async () => {
        const btn = document.getElementById('get-packages-btn');
        const originalHtml = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = `
            <span class="loading loading-spinner loading-xs"></span>
            Loading...
        `;
        
        try {
            const response = await fetch(`/api/scripts/${scriptId}/packages`);
            const result = await response.json();
            
            if (response.ok) {
                if (result.packages && result.packages.length > 0) {
                    const content = result.packages.join('\n');
                    appendBlockToConsole('Installed Packages', content, 'info');
                    window.showToast?.('Current packages list shown in Output Console', 'info');
                } else {
                    appendBlockToConsole('Installed Packages', 'No packages found in current environment', 'info');
                }
            } else {
                throw new Error(result.detail || 'Failed to get packages');
            }
        } catch (err) {
            appendBlockToConsole('Packages Error', err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
        });
    }
    
    // Install dependencies
    const installDepsBtn = document.getElementById('install-deps-btn');
    if (installDepsBtn) {
        installDepsBtn.addEventListener('click', async () => {
        const installBtn = document.getElementById('install-deps-btn');
        const depsInput = document.getElementById('dependencies-input');
        const dependencies = depsInput.value.trim();
        
        // Step 1: Validate dependencies first
        if (dependencies) {
            installBtn.disabled = true;
            installBtn.innerHTML = `
                <span class="loading loading-spinner loading-xs"></span>
                Validating...
            `;
            
            try {
                const validateResponse = await fetch('/api/scripts/validate-dependencies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dependencies }),
                });
                
                const validateResult = await validateResponse.json();
                
                if (!validateResult.valid) {
                    // Show validation error in console
                    appendBlockToConsole('Validation Error', validateResult.message, 'error');
                    setConsoleStatus('Error', 'badge-error');
                    // Scroll to console
                    document.getElementById('output-console')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Highlight dependencies input
                    depsInput.classList.add('textarea-error');
                    depsInput.addEventListener('input', () => {
                        depsInput.classList.remove('textarea-error');
                    }, { once: true });
                    
                    // Reset button
                    installBtn.disabled = false;
                    installBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Install
                    `;
                    return;
                }
            } catch (err) {
                appendBlockToConsole('Validation Error', err.message, 'error');
                setConsoleStatus('Error', 'badge-error');
                document.getElementById('output-console')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                installBtn.disabled = false;
                installBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Install
                `;
                return;
            }
        }
        
        if (!confirm('This will rebuild the virtual environment and install all dependencies. This may take a few minutes. Continue?')) {
            installBtn.disabled = false;
            installBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Install
            `;
            return;
        }
        
        // Step 2: Save script first to use current dependencies
        installBtn.innerHTML = `
            <span class="loading loading-spinner loading-xs"></span>
            Saving...
        `;
        
        try {
            editor.save();
            const form = document.getElementById('script-form');
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                content: formData.get('content'),
                cron_expression: formData.get('cron_expression'),
                python_version: formData.get('python_version'),
                timeout: parseInt(formData.get('timeout')),
                misfire_grace_time: parseInt(formData.get('misfire_grace_time')),
                enabled: formData.get('enabled') === 'true',
                dependencies: formData.get('dependencies'),
                alert_on_failure: formData.get('alert_on_failure') === 'true',
                alert_on_success: formData.get('alert_on_success') === 'true',
                environment_vars: formData.get('environment_vars'),
            };
            
            const saveResponse = await fetch(`/api/scripts/${scriptId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            
            if (!saveResponse.ok) {
                const error = await saveResponse.json();
                throw new Error(error.detail || 'Failed to save script');
            }
        } catch (err) {
            resultDiv.className = 'alert alert-error mt-3';
            resultDiv.innerHTML = `<span>Save error: ${err.message}</span>`;
            resultDiv.classList.remove('hidden');
            installBtn.disabled = false;
            installBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Install
            `;
            return;
        }
        
        // Step 3: Now rebuild environment (using SSE)
        installBtn.innerHTML = `
            <span class="loading loading-spinner loading-xs"></span>
            Preparing...
        `;
        
        // Use Output Console for full progress
        outputConsole.innerHTML = '';
        logBuffer = [];
        setConsoleStatus('Installing', 'badge-info');
        appendBlockToConsole('Environment Setup', 'Starting environment rebuild and dependency installation...', 'info');
        
        try {
            // Start installation
            const installResponse = await fetch(`/api/scripts/${scriptId}/install`, {
                method: 'POST',
            });
            
            if (!installResponse.ok) {
                const err = await installResponse.json();
                if (installResponse.status === 409) {
                    throw new Error(err.detail || 'Cannot install dependencies while script is running. Stop the execution first.');
                }
                throw new Error(err.detail || 'Failed to start installation');
            }
            
            // Connect to SSE stream
            const eventSource = new EventSource(`/api/scripts/${scriptId}/install-stream`);
            
            eventSource.onmessage = (event) => {
                appendToConsole(event.data, true);
            };
            
            eventSource.addEventListener('done', (event) => {
                eventSource.close();
                const data = JSON.parse(event.data);
                if (data.success) {
                    setConsoleStatus('Complete', 'badge-success');
                    appendBlockToConsole('Installation Complete', 'Dependencies installed successfully!', 'success');
                    window.showToast?.('Dependencies installed successfully', 'success');
                    lastInstallFailed = false;
                    retryBtn.style.display = 'none';
                } else {
                    setConsoleStatus('Failed', 'badge-error');
                    appendBlockToConsole('Installation Failed', 'Check logs for details', 'error');
                    window.showToast?.('Installation failed', 'error');
                    lastInstallFailed = true;
                    retryBtn.style.display = 'inline-flex';
                }
                
                installBtn.disabled = false;
                installBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Install
                `;
            });
            
            eventSource.addEventListener('error', (event) => {
                setConsoleStatus('Error', 'badge-error');
                appendBlockToConsole('Connection Error', 'SSE stream disconnected prematurely', 'error');
                eventSource.close();
                lastInstallFailed = true;
                retryBtn.style.display = 'inline-flex';
                installBtn.disabled = false;
                installBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Install
                `;
            });
            
            eventSource.onerror = (error) => {
                if (eventSource.readyState === EventSource.CLOSED) return;
                setConsoleStatus('Error', 'badge-error');
                appendBlockToConsole('Stream Error', 'An error occurred while streaming logs', 'error');
                eventSource.close();
                lastInstallFailed = true;
                retryBtn.style.display = 'inline-flex';
                installBtn.disabled = false;
                installBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Install
                `;
            };
            
        } catch (err) {
            setConsoleStatus('Error', 'badge-error');
            appendBlockToConsole('Setup Error', err.message, 'error');
            installBtn.disabled = false;
            installBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Install
            `;
        }
    });
    }
    
    // Handle form submission
    document.getElementById('script-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Update textarea with editor content
        editor.save();
        
        const form = e.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnHtml = submitBtn.innerHTML;
        const hasDeps = formData.get('dependencies')?.trim();
        
        // Show loading state on button
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span class="loading loading-spinner loading-sm"></span>
            ${hasDeps ? 'Saving & Installing dependencies...' : 'Saving...'}
        `;
        
        // Convert form data to JSON
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            content: formData.get('content'),
            cron_expression: formData.get('cron_expression'),
            python_version: formData.get('python_version'),
            timeout: parseInt(formData.get('timeout')),
            misfire_grace_time: parseInt(formData.get('misfire_grace_time')),
            enabled: formData.get('enabled') === 'true',
            dependencies: formData.get('dependencies'),
            alert_on_failure: formData.get('alert_on_failure') === 'true',
            alert_on_success: formData.get('alert_on_success') === 'true',
            environment_vars: formData.get('environment_vars'),
        };
        
        try {
            const isNew = !form.action.includes('/api/scripts/');
            const url = isNew ? '/api/scripts' : form.action;
            const method = isNew ? 'POST' : 'PUT';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Save result:', result);
                console.log('needs_install:', result.needs_install);
                
                // Check if installation is needed
                if (result.needs_install) {
                    // Update button to show installing state
                    submitBtn.innerHTML = `
                        <span class="loading loading-spinner loading-sm"></span>
                        Installing dependencies...
                    `;
                    
                    // Clear and prepare console
                    outputConsole.innerHTML = '';
                    logBuffer = [];
                    setConsoleStatus('Installing', 'badge-info');
                    appendBlockToConsole('Environment Setup', 'Starting environment rebuild and dependency installation after save...', 'info');
                    
                    // Start installation
                    const installResponse = await fetch(`/api/scripts/${result.id}/install`, {
                        method: 'POST',
                    });
                    
                    if (!installResponse.ok) {
                        const err = await installResponse.json();
                        throw new Error(err.detail || 'Failed to start installation');
                    }
                    
                    // Connect to SSE stream
                    const eventSource = new EventSource(`/api/scripts/${result.id}/install-stream`);
                    
                    eventSource.onmessage = (event) => {
                        appendToConsole(event.data, true);
                    };
                    
                    eventSource.addEventListener('done', (event) => {
                        eventSource.close();
                        const data = JSON.parse(event.data);
                        if (data.success) {
                            setConsoleStatus('Complete', 'badge-success');
                            appendBlockToConsole('Installation Complete', 'Dependencies installed successfully!', 'success');
                            window.showToast?.('Script saved and dependencies installed', 'success');
                            // Update originalDeps to new value on success
                            originalDeps = depsInput.value;
                            diffContainer.style.display = 'none';
                            lastInstallFailed = false;
                            retryBtn.style.display = 'none';
                            setTimeout(() => {
                                window.location.href = '/scripts/' + result.id;
                            }, 1500);
                        } else {
                            setConsoleStatus('Failed', 'badge-error');
                            appendBlockToConsole('Installation Failed', 'Check logs for details', 'error');
                            window.showToast?.('Installation failed', 'error');
                            lastInstallFailed = true;
                            retryBtn.style.display = 'inline-flex';
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnHtml;
                        }
                    });
                    
                    eventSource.addEventListener('error', (event) => {
                        setConsoleStatus('Error', 'badge-error');
                        appendBlockToConsole('Connection Error', 'SSE stream disconnected prematurely', 'error');
                        eventSource.close();
                        lastInstallFailed = true;
                        retryBtn.style.display = 'inline-flex';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnHtml;
                    });
                    
                    eventSource.onerror = (error) => {
                        // Connection closed normally after 'done' event is fine
                        if (eventSource.readyState === EventSource.CLOSED) {
                            return;
                        }
                        setConsoleStatus('Error', 'badge-error');
                        appendBlockToConsole('Stream Error', 'An error occurred while streaming logs', 'error');
                        eventSource.close();
                        lastInstallFailed = true;
                        retryBtn.style.display = 'inline-flex';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnHtml;
                    };
                } else {
                    // No installation needed, redirect immediately
                    console.log('No installation needed, redirecting...');
                    // Update originalDeps to new value
                    originalDeps = depsInput.value;
                    diffContainer.style.display = 'none';
                    window.location.href = '/scripts/' + result.id;
                }
            } else {
                const error = await response.json();
                window.showToast?.('Error: ' + (error.detail || 'Failed to save script'), 'error');
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHtml;
            }
        } catch (err) {
            window.showToast?.('Error: ' + err.message, 'error');
            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHtml;
        }
    });
    
    // Output console management
    const outputConsole = document.getElementById('output-console');
    const consoleStatus = document.getElementById('console-status');
    const clearOutputBtn = document.getElementById('clear-output-btn');
    const copyOutputBtn = document.getElementById('copy-output-btn');
    const downloadOutputBtn = document.getElementById('download-output-btn');
    const validateBtn = document.getElementById('validate-btn');
    const runTestBtn = document.getElementById('run-test-btn');
    const stopTestBtn = document.getElementById('stop-test-btn');
    const reconnectBtn = document.getElementById('reconnect-btn');
    const autoScrollToggle = document.getElementById('auto-scroll-toggle');

    
    let currentEventSource = null;
    let currentExecutionId = null;
    let autoScrollEnabled = true;


    // Persist console preferences
    try {
        autoScrollEnabled = localStorage.getItem('consoleAutoScroll') !== 'false';
    } catch (e) {}
    autoScrollToggle.checked = autoScrollEnabled;

    autoScrollToggle.addEventListener('change', (e) => {
        autoScrollEnabled = !!e.target.checked;
        try { localStorage.setItem('consoleAutoScroll', String(autoScrollEnabled)); } catch (err) {}
    });

    
    function appendToConsole(text, animate = true) {
        // Format and render
        const formatted = formatLogData(text);
        renderLogLine(formatted, animate);
    }

    function appendBlockToConsole(title, content, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const separator = '—'.repeat(20);
        const icon = type === 'success' ? '✅' : (type === 'error' ? '❌' : 'ℹ️');
        
        const block = `
${separator}
${icon} ${title.toUpperCase()} [${timestamp}]
${separator}
${content}
${separator}
`;
        appendToConsole(block, true);
        
        // Auto-scroll and focus
        outputConsole.parentElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    
    function renderLogLine(text, animate = true) {
        // Split by newlines and create separate divs
        const lines = text.split('\n');
        lines.forEach((lineText, index) => {
            // Skip empty lines except the last one
            if (!lineText && index < lines.length - 1) return;
            
            const line = document.createElement('div');
            line.textContent = lineText || ' '; // Use space for empty lines
            if (animate) {
                line.style.opacity = '0';
                line.style.transition = 'opacity 0.3s ease-in';
            }
            outputConsole.appendChild(line);
            if (animate) {
                setTimeout(() => line.style.opacity = '1', 10);
            }
        });
        // Auto-scroll to bottom (optional)
        if (autoScrollEnabled) {
            outputConsole.scrollTop = outputConsole.scrollHeight;
        }
    }
    

    
    function formatLogData(data) {
        // Try to parse as JSON (cronator_lib logs)
        try {
            const logData = JSON.parse(data);
            if (logData.message) {
                const timestamp = new Date(logData.timestamp).toLocaleTimeString();
                return `[${timestamp}] ${logData.level.padEnd(8)} ${logData.message}`;
            }
        } catch (e) {
            // Not JSON, return as-is
        }
        return data;
    }
    
    function setConsoleStatus(status, badgeClass = 'badge-ghost') {
        consoleStatus.textContent = status;
        consoleStatus.className = `badge ${badgeClass}`;
    }
    
    clearOutputBtn.addEventListener('click', () => {
        outputConsole.innerHTML = '';
        logBuffer = []; // Clear buffer too
    });

    copyOutputBtn.addEventListener('click', async () => {
        try {
            const text = outputConsole.innerText || '';
            await navigator.clipboard.writeText(text);
            window.showToast?.('Copied to clipboard', 'success');
        } catch (err) {
            window.showToast?.('Copy failed (clipboard permissions)', 'error');
        }
    });

    downloadOutputBtn.addEventListener('click', () => {
        const text = outputConsole.innerText || '';
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cronator-test-output-${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        window.showToast?.('Download started', 'info');
    });
    
    // Validate script
    validateBtn.addEventListener('click', async () => {
        editor.save();
        const code = document.getElementById('code-editor').value;
        
        validateBtn.disabled = true;
        validateBtn.textContent = 'Validating...';
        setConsoleStatus('Validating...', 'badge-info');
        
        try {
            const response = await fetch('/api/scripts/validate-script', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code }),
            });
            
            const result = await response.json();
            
            if (result.valid) {
                appendToConsole(result.message, true);
                setConsoleStatus('Idle', 'badge-success');
            } else {
                appendToConsole(result.message, true);
                result.errors.forEach(err => {
                    appendToConsole(`  Line ${err.line}, Column ${err.column}: [${err.code}] ${err.message}`, true);
                });
                setConsoleStatus('Validation Failed', 'badge-error');
            }
        } catch (err) {
            appendToConsole(`Error: ${err.message}`, true);
            setConsoleStatus('Error', 'badge-error');
        } finally {
            validateBtn.disabled = false;
            validateBtn.innerHTML = `{{ icons.check_circle("w-4 h-4") | safe }} Validate`;
        }
    });
    
    // Run test
    runTestBtn.addEventListener('click', async () => {
        editor.save();
        
        // Collect form data
        const form = document.getElementById('script-form');
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            content: formData.get('content'),
            cron_expression: formData.get('cron_expression'),
            python_version: formData.get('python_version'),
            timeout: parseInt(formData.get('timeout')),
            misfire_grace_time: parseInt(formData.get('misfire_grace_time')),
            enabled: formData.get('enabled') === 'true',
            dependencies: formData.get('dependencies'),
            alert_on_failure: formData.get('alert_on_failure') === 'true',
            alert_on_success: formData.get('alert_on_success') === 'true',
            environment_vars: formData.get('environment_vars'),
        };
        
        // For new scripts, require a name
        let currentScriptId = scriptId;
        
        try {
            runTestBtn.disabled = true;
            
            if (!currentScriptId) {
                // New script - check if name is provided
                if (!data.name || !data.name.trim()) {
                    window.showToast?.('Script name is required', 'error');
                    runTestBtn.disabled = false;
                    // Highlight and focus on name field
                    const nameInput = document.querySelector('input[name="name"]');
                    if (nameInput) {
                        nameInput.classList.add('input-error');
                        nameInput.focus();
                        // Remove error class after user starts typing
                        nameInput.addEventListener('input', () => {
                            nameInput.classList.remove('input-error');
                        }, { once: true });
                    }
                    return;
                }
                
                // Create new script first
                setConsoleStatus('Creating...', 'badge-info');
                appendBlockToConsole('Auto-save', 'Creating script before test run...', 'info');
                
                const createResponse = await fetch('/api/scripts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.detail || 'Failed to create script');
                }
                
                const createResult = await createResponse.json();
                currentScriptId = createResult.id;
                
                // Update the form's data-script-id and action for future saves
                form.dataset.scriptId = currentScriptId;
                form.action = `/api/scripts/${currentScriptId}`;
                
                // Update URL without reload
                window.history.replaceState({}, '', `/scripts/${currentScriptId}/edit`);
                
                appendBlockToConsole('Auto-save', `Script created with ID: ${currentScriptId}`, 'success');
            } else {
                // Existing script - save changes
                setConsoleStatus('Saving...', 'badge-info');
                
                const saveResponse = await fetch(`/api/scripts/${currentScriptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                
                if (!saveResponse.ok) {
                    const error = await saveResponse.json();
                    throw new Error(error.detail || 'Failed to save script');
                }
            }
            
            // Start test
            appendToConsole('\n--- Test Started ---', false);
            setConsoleStatus('Running...', 'badge-warning');
            
            const testResponse = await fetch(`/api/scripts/${currentScriptId}/test`, {
                method: 'POST',
            });
            
            if (!testResponse.ok) {
                const error = await testResponse.json();
                throw new Error(error.detail || 'Failed to start test');
            }
            
            const testResult = await testResponse.json();
            currentExecutionId = testResult.execution_id;
            
            // Show stop button
            runTestBtn.style.display = 'none';
            stopTestBtn.style.display = 'inline-flex';
            
            // Connect to SSE stream
            currentEventSource = new EventSource(`/api/executions/${currentExecutionId}/stream`);
            
            currentEventSource.onmessage = (event) => {
                appendToConsole(event.data, true);
            };
            
            currentEventSource.addEventListener('done', (event) => {
                const data = JSON.parse(event.data);
                appendToConsole(`\n--- Test Finished: ${data.status} (exit code: ${data.exit_code}) ---`, false);
                
                if (data.status === 'success') {
                    setConsoleStatus('Success', 'badge-success');
                } else if (data.status === 'cancelled') {
                    setConsoleStatus('Cancelled', 'badge-warning');
                } else {
                    setConsoleStatus('Failed', 'badge-error');
                }
                
                currentEventSource.close();
                currentEventSource = null;
                currentExecutionId = null;
                runTestBtn.style.display = 'inline-flex';
                stopTestBtn.style.display = 'none';
                runTestBtn.disabled = false;
            });
            
            currentEventSource.onerror = (error) => {
                console.error('SSE Error:', error);
                appendToConsole('\\n[Connection lost]', false);
                setConsoleStatus('Disconnected', 'badge-error');
                reconnectBtn.style.display = 'inline-flex';
                
                if (currentEventSource) {
                    currentEventSource.close();
                    currentEventSource = null;
                }
                runTestBtn.style.display = 'inline-flex';
                stopTestBtn.style.display = 'none';
                runTestBtn.disabled = false;
            };
            
        } catch (err) {
            appendToConsole(`Error: ${err.message}`, false);
            setConsoleStatus('Error', 'badge-error');
            window.showToast?.(err.message, 'error');
            runTestBtn.disabled = false;
            runTestBtn.style.display = 'inline-flex';
            stopTestBtn.style.display = 'none';
        }
    });
    
    // Stop test
    stopTestBtn.addEventListener('click', async () => {
        if (!currentExecutionId) return;
        
        try {
            const response = await fetch(`/api/executions/${currentExecutionId}/cancel`, {
                method: 'POST',
            });
            
            if (response.ok) {
                appendToConsole('\\n[Test stopped by user]', false);
            }
        } catch (err) {
            console.error('Failed to stop test:', err);
        }
        
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
        
        currentExecutionId = null;
        stopTestBtn.style.display = 'none';
        runTestBtn.style.display = 'inline-flex';
        runTestBtn.disabled = false;
        setConsoleStatus('Stopped', 'badge-warning');
    });
    
    // Reconnect
    reconnectBtn.addEventListener('click', () => {
        reconnectBtn.style.display = 'none';
        runTestBtn.click();
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (currentEventSource) {
            currentEventSource.close();
        }
        if (currentExecutionId) {
            // Try to cancel execution (best effort)
            fetch(`/api/executions/${currentExecutionId}/cancel`, { method: 'POST' }).catch(() => {});
        }
    });

    // ==================== Version History ====================
    
    async function loadVersionHistory() {
        console.log('[Version History] Loading versions for script:', scriptId);
        const versionsList = document.getElementById('versions-list');
        const versionBadge = document.getElementById('version-count-badge');
        
        if (!scriptId) {
            console.log('[Version History] No scriptId, skipping load');
            return;
        }
        
        try {
            console.log('[Version History] Fetching from:', `/api/scripts/${scriptId}/versions`);
            const response = await fetch(`/api/scripts/${scriptId}/versions`);
            if (!response.ok) throw new Error('Failed to load versions');
            
            const data = await response.json();
            console.log('[Version History] Loaded', data.total, 'versions:', data);
            versionBadge.textContent = data.total;
            
            if (data.total === 0) {
                versionsList.innerHTML = '<div class="text-sm text-gray-500 italic p-3">No versions yet. Versions are created automatically when you save changes.</div>';
                return;
            }
            
            versionsList.innerHTML = data.items.map(v => {
                const date = new Date(v.created_at).toLocaleString();
                const sizeKB = (v.content_size / 1024).toFixed(1);
                return `
                    <div class="flex items-center justify-between p-3 bg-base-100 rounded hover:bg-base-300 transition-colors border border-base-300">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="badge badge-sm badge-primary">v${v.version_number}</span>
                                <span class="text-xs text-gray-500">${date}</span>
                                <span class="text-xs text-gray-400">${sizeKB} KB</span>
                            </div>
                            ${v.change_summary ? `<div class="text-sm mt-1 text-gray-700">${escapeHtml(v.change_summary)}</div>` : '<div class="text-xs mt-1 text-gray-400 italic">No description</div>'}
                        </div>
                        <div class="flex gap-2 ml-4">
                            <a href="/scripts/${scriptId}/versions/${v.version_number}" class="btn btn-sm btn-outline btn-info" title="View version ${v.version_number} content">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <span class="hidden sm:inline">View</span>
                            </a>
                            <button type="button" data-action="restore" data-version="${v.version_number}" class="btn btn-sm btn-outline btn-warning" title="Restore script to version ${v.version_number}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                </svg>
                                <span class="hidden sm:inline">Restore</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for restore buttons
            document.querySelectorAll('#versions-list button[data-action="restore"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const version = parseInt(btn.dataset.version);
                    revertToVersion(version);
                });
            });
            
        } catch (err) {
            console.error('Failed to load versions:', err);
            versionsList.innerHTML = '<div class="text-sm text-error p-3">Failed to load versions</div>';
        }
    }
    
    async function revertToVersion(versionNumber) {
        if (!confirm(`Restore script to version ${versionNumber}?\n\nThis will:\n- Replace current content with version ${versionNumber}\n- Create a new version with current state\n- Trigger dependency reinstall if needed`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/scripts/${scriptId}/revert/${versionNumber}`, {
                method: 'POST'
            });
            
            if (!response.ok) throw new Error('Failed to revert');
            
            const result = await response.json();
            window.showToast?.(result.message, 'success');
            
            // Reload page to show reverted content
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (err) {
            console.error('Failed to revert:', err);
            window.showToast?.('Failed to revert to version', 'error');
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load versions on page load for editing
    {% if script %}
    document.addEventListener('DOMContentLoaded', () => {
        loadVersionHistory();
    });
    {% endif %}
    
    // Reload versions after save
    const originalFormSubmit = document.querySelector('form').onsubmit;
    document.querySelector('form').addEventListener('submit', async function(e) {
        // Let original handler run first
        if (originalFormSubmit) {
            const result = await originalFormSubmit.call(this, e);
            if (result === false) return false;
        }
        // After successful save, reload versions
        setTimeout(() => {
            if (scriptId) loadVersionHistory();
        }, 2000);
    });

</script>
{% endblock %}

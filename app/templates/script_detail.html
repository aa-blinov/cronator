{% extends "base.html" %}
{% import "icons.html" as icons %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <button id="run-now-btn" class="btn btn-primary btn-sm gap-2">
        {{ icons.play("w-4 h-4") }} Run Now
    </button>
    <a href="/scripts/{{ script.id }}/edit" class="btn btn-ghost btn-sm gap-2">
        {{ icons.pencil("w-4 h-4") }} Edit
    </a>
    <button id="toggle-btn" class="btn btn-ghost btn-sm gap-2">
        {% if script.enabled %}{{ icons.pause("w-4 h-4") }} Disable{% else %}{{ icons.play("w-4 h-4") }} Enable{% endif %}
    </button>
    <button type="button" onclick="deleteScript({{ script.id }})" class="btn btn-error btn-sm gap-2">
        {{ icons.trash("w-4 h-4") }} Delete
    </button>
</div>

<script>
function deleteScript(scriptId) {
    if (!confirm('Delete this script? This will remove the script, its environment, scheduled jobs, and all execution history. This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/scripts/${scriptId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/';
        } else if (response.status === 409) {
            return response.json().then(data => {
                window.showToast?.(data.detail || 'Cannot delete script while it is running', 'error');
            });
        } else {
            return response.json().then(data => {
                window.showToast?.(`Failed to delete script: ${data.detail || 'Unknown error'}`, 'error');
            });
        }
    })
    .catch(error => {
        window.showToast?.(`Error deleting script: ${error.message}`, 'error');
    });
}
</script>
{% endblock %}

{% block content %}
<!-- Script Info -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2 glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Script Information</h3>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-gray-400 text-sm">Name</p>
                <p class="font-medium">{{ script.name }}</p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Status</p>
                <p>
                    {% if script.enabled %}
                        <span class="badge badge-success">Enabled</span>
                    {% else %}
                        <span class="badge badge-ghost">Disabled</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Schedule</p>
                <code class="text-sm bg-gray-800 px-2 py-1 rounded">{{ script.cron_expression }}</code>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Python Version</p>
                <p>{{ script.python_version }}</p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Timeout</p>
                <p>{{ script.timeout }}s</p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Next Run</p>
                <p>{% if next_run %}{{ next_run.strftime('%Y-%m-%d %H:%M:%S UTC') }}{% else %}-{% endif %}</p>
            </div>
            <div class="col-span-2">
                <p class="text-gray-400 text-sm">Path</p>
                <code class="text-xs bg-gray-800 px-2 py-1 rounded break-all">{{ script.path }}</code>
            </div>
            {% if script.description %}
            <div class="col-span-2">
                <p class="text-gray-400 text-sm">Description</p>
                <p>{{ script.description }}</p>
            </div>
            {% endif %}
        </div>
        
        {% if script.dependencies %}
        <div class="mt-6">
            <p class="text-gray-400 text-sm mb-2">Dependencies</p>
            <pre class="log-output text-xs">{{ script.dependencies }}</pre>
        </div>
        {% endif %}
    </div>
    
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Statistics</h3>
        
        <div class="space-y-4">
            <div>
                <p class="text-gray-400 text-sm">Total Executions</p>
                <p class="text-2xl font-bold">{{ stats.total }}</p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Success Rate</p>
                <p class="text-2xl font-bold {% if stats.total == 0 %}text-orange-400{% elif stats.success_rate >= 90 %}text-green-400{% elif stats.success_rate >= 50 %}text-yellow-400{% else %}text-red-400{% endif %}">
                    {{ stats.success_rate }}%
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Alerts</p>
                <p class="flex items-center gap-2">
                    {% if script.alert_on_failure %}
                        <span class="badge badge-error badge-sm">On Failure</span>
                    {% endif %}
                    {% if script.alert_on_success %}
                        <span class="badge badge-success badge-sm">On Success</span>
                    {% endif %}
                    {% if not script.alert_on_failure and not script.alert_on_success %}
                        <span class="text-gray-500">None</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-sm">Last Alert Sent</p>
                <p class="font-medium text-sm">
                    {{ script.last_alert_at.strftime('%Y-%m-%d %H:%M:%S') if script.last_alert_at else 'Never' }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Execution History -->
<div class="glass-card rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Execution History</h3>
        <div class="form-control">
            <label class="label cursor-pointer gap-2">
                <span class="label-text text-sm">Show test runs</span>
                <input type="checkbox" id="show-test-runs" class="checkbox checkbox-sm" />
            </label>
        </div>
    </div>
    
    {% if executions %}
    <div class="overflow-x-auto">
        <table class="table w-full">
            <thead>
                <tr class="border-b border-gray-700/50">
                    <th class="bg-transparent">ID</th>
                    <th class="bg-transparent">Status</th>
                    <th class="bg-transparent">Started</th>
                    <th class="bg-transparent">Duration</th>
                    <th class="bg-transparent">Exit Code</th>
                    <th class="bg-transparent">Triggered By</th>
                    <th class="bg-transparent">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for exec in executions %}
                <tr class="border-b border-gray-700/30 hover:bg-white/5 {% if exec.is_test %}test-run{% endif %}" {% if exec.status == 'running' %}data-status="running" data-execution-id="{{ exec.id }}"{% endif %}>
                    <td>
                        <div class="flex items-center gap-2">
                            <a href="/executions/{{ exec.id }}" class="text-indigo-400 hover:underline">#{{ exec.id }}</a>
                            {% if exec.is_test %}
                                <span class="badge badge-info badge-xs">Test</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge {{ exec.status }}" id="status-{{ exec.id }}">
                            {% if exec.status == 'running' %}
                                <span class="pulse-dot"></span>
                            {% endif %}
                            {{ exec.status }}
                        </span>
                    </td>
                    <td>{{ exec.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ exec.duration_formatted }}</td>
                    <td>
                        {% if exec.exit_code is not none %}
                            <code class="{% if exec.exit_code == 0 %}text-green-400{% else %}text-red-400{% endif %}">{{ exec.exit_code }}</code>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-ghost badge-sm">{{ exec.triggered_by }}</span>
                    </td>
                    <td>
                        <div class="flex gap-1">
                            <a href="/executions/{{ exec.id }}" class="btn btn-ghost btn-xs">View</a>
                            {% if exec.status == 'running' %}
                                <button class="btn btn-error btn-xs cancel-execution-btn" data-execution-id="{{ exec.id }}">
                                    Cancel
                                </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="px-6 py-4 border-t border-gray-700/50 flex items-center justify-between">
        <p class="text-sm text-gray-400">
            Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total] | min }} of {{ pagination.total }}
        </p>
        <div class="join">
            {% if pagination.page > 1 %}
            <a href="?page={{ pagination.page - 1 }}" class="join-item btn btn-sm">«</a>
            {% endif %}
            
            {% for p in range(1, pagination.pages + 1) %}
                {% if p == pagination.page %}
                    <button class="join-item btn btn-sm btn-active">{{ p }}</button>
                {% elif p <= 3 or p > pagination.pages - 2 or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
                    <a href="?page={{ p }}" class="join-item btn btn-sm">{{ p }}</a>
                {% elif p == 4 or p == pagination.pages - 2 %}
                    <button class="join-item btn btn-sm btn-disabled">...</button>
                {% endif %}
            {% endfor %}
            
            {% if pagination.page < pagination.pages %}
            <a href="?page={{ pagination.page + 1 }}" class="join-item btn btn-sm">»</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="p-12 text-center">
        {{ icons.inbox("w-20 h-20 mb-4 opacity-50 mx-auto") }}
        <h3 class="text-xl font-medium text-gray-400 mb-2">No executions yet</h3>
        <p class="text-gray-500 mb-6">Run the script to see execution history</p>
        <button id="run-now-empty-btn" class="btn btn-primary gap-2">
            {{ icons.play("w-4 h-4") }} Run Now
        </button>
    </div>
    {% endif %}
</div>

<script>
const scriptId = {{ script.id }};
const playIcon = `{{ icons.play("w-4 h-4") }}`.trim();
const pauseIcon = `{{ icons.pause("w-4 h-4") }}`.trim();

// Run Now button handler
document.getElementById('run-now-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('run-now-btn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Running...';
    
    try {
        const response = await fetch(`/api/scripts/${scriptId}/run`, { method: 'POST' });
        
        if (response.ok) {
            const result = await response.json();
            // Reload page to show new execution
            window.showToast?.('Script started', 'success');
            setTimeout(() => window.location.reload(), 2800);
        } else if (response.status === 409) {
            const error = await response.json();
            window.showToast?.(error.detail || 'Script is already running', 'warning');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        } else {
            const error = await response.json();
            window.showToast?.(error.detail || 'Failed to run script', 'error');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        window.showToast?.(err.message || 'Failed to run script', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Empty state Run Now button
document.getElementById('run-now-empty-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('run-now-empty-btn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Running...';
    
    try {
        const response = await fetch(`/api/scripts/${scriptId}/run`, { method: 'POST' });
        
        if (response.ok) {
            window.showToast?.('Script started', 'success');
            setTimeout(() => window.location.reload(), 2800);
        } else {
            const error = await response.json();
            window.showToast?.(error.detail || 'Failed to run script', 'error');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        window.showToast?.(err.message || 'Failed to run script', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Toggle enabled/disabled button
document.getElementById('toggle-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('toggle-btn');
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/scripts/${scriptId}/toggle`, { method: 'POST' });
        
        if (response.ok) {
            window.showToast?.('Script toggled', 'success');
            setTimeout(() => window.location.reload(), 2800);
        } else {
            const error = await response.json();
            window.showToast?.(error.detail || 'Failed to toggle script', 'error');
            btn.disabled = false;
        }
    } catch (err) {
        window.showToast?.(err.message || 'Failed to toggle script', 'error');
        btn.disabled = false;
    }
});

// Test runs filter with localStorage
const showTestRunsCheckbox = document.getElementById('show-test-runs');
const testRuns = document.querySelectorAll('.test-run');

// Load saved preference
const showTests = localStorage.getItem('showTestRuns') === 'true';
showTestRunsCheckbox.checked = showTests;
testRuns.forEach(row => {
    row.style.display = showTests ? '' : 'none';
});

showTestRunsCheckbox.addEventListener('change', (e) => {
    const show = e.target.checked;
    localStorage.setItem('showTestRuns', show);
    testRuns.forEach(row => {
        row.style.display = show ? '' : 'none';
    });
});

// Cancel execution buttons
document.querySelectorAll('.cancel-execution-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const executionId = e.target.dataset.executionId;
        
        if (!confirm('Are you sure you want to cancel this execution?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/executions/${executionId}/cancel`, {
                method: 'POST',
            });
            
            if (response.ok) {
                // Update UI
                const row = document.querySelector(`tr[data-execution-id="${executionId}"]`);
                const statusBadge = document.getElementById(`status-${executionId}`);
                
                if (statusBadge) {
                    statusBadge.className = 'status-badge cancelled';
                    statusBadge.innerHTML = 'cancelled';
                }
                
                // Remove cancel button
                e.target.remove();

                window.showToast?.('Execution cancelled', 'success');
                
                // Show success message (optional)
                // alert('Execution cancelled');
            } else {
                const error = await response.json();
                window.showToast?.(error.detail || 'Failed to cancel execution', 'error');
            }
        } catch (err) {
            window.showToast?.(err.message || 'Failed to cancel execution', 'error');
        }
    });
});

// Auto-refresh execution history
let autoRefreshInterval = null;

async function refreshExecutionHistory() {
    try {
        const response = await fetch(`/scripts/${scriptId}`, {
            headers: { 'X-Refresh-Only': 'true' }
        });
        
        if (!response.ok) return;
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Find the execution table in the response
        const newTable = doc.querySelector('.overflow-x-auto');
        const currentTable = document.querySelector('.overflow-x-auto');
        
        if (newTable && currentTable) {
            // Check if content changed before updating
            if (currentTable.innerHTML !== newTable.innerHTML) {
                currentTable.innerHTML = newTable.innerHTML;
                
                // Re-apply test runs filter
                const showTests = localStorage.getItem('showTestRuns') === 'true';
                document.querySelectorAll('.test-run').forEach(row => {
                    row.style.display = showTests ? '' : 'none';
                });
                
                // Re-attach cancel button listeners
                document.querySelectorAll('.cancel-execution-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const executionId = e.target.dataset.executionId;
                        if (!confirm('Are you sure you want to cancel this execution?')) return;
                        
                        try {
                            const resp = await fetch(`/api/executions/${executionId}/cancel`, { method: 'POST' });
                            if (resp.ok) {
                                const statusBadge = document.getElementById(`status-${executionId}`);
                                if (statusBadge) {
                                    statusBadge.className = 'status-badge cancelled';
                                    statusBadge.innerHTML = 'cancelled';
                                }
                                e.target.remove();
                                window.showToast?.('Execution cancelled', 'success');
                            } else {
                                const error = await resp.json();
                                window.showToast?.(error.detail || 'Failed to cancel execution', 'error');
                            }
                        } catch (err) {
                            window.showToast?.(err.message || 'Failed to cancel execution', 'error');
                        }
                    });
                });
            }
        }
    } catch (err) {
        console.error('Failed to refresh execution history:', err);
    }
}

// Check if there are running executions
const hasRunningExecutions = document.querySelector('tr[data-status="running"]') !== null;

// Start auto-refresh if there are running executions
if (hasRunningExecutions) {
    autoRefreshInterval = setInterval(refreshExecutionHistory, 3000); // Every 3 seconds
}

// Also refresh periodically to catch new scheduled executions
const slowRefreshInterval = setInterval(refreshExecutionHistory, 30000); // Every 30 seconds

// Stop refresh on page unload
window.addEventListener('beforeunload', () => {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    clearInterval(slowRefreshInterval);
});
</script>
{% endblock %}

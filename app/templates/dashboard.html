{% extends "base.html" %}
{% import "icons.html" as icons %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="stat-card glass-card rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm">Total Scripts</p>
                <p class="text-3xl font-bold mt-1">{{ stats.total_scripts }}</p>
            </div>
            {{ icons.clipboard("w-10 h-10 opacity-50") }}
        </div>
    </div>
    
    <div class="stat-card glass-card rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm">Enabled</p>
                <p class="text-3xl font-bold mt-1 text-green-400">{{ stats.enabled_scripts }}</p>
            </div>
            {{ icons.check_circle("w-10 h-10 opacity-50 text-green-400") }}
        </div>
    </div>
    
    <div class="stat-card glass-card rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm">Today's Runs</p>
                <p class="text-3xl font-bold mt-1 text-blue-400">{{ stats.today_executions }}</p>
            </div>
            {{ icons.arrow_path("w-10 h-10 opacity-50 text-blue-400") }}
        </div>
    </div>
    
    <div class="stat-card glass-card rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm">Failed Today</p>
                <p class="text-3xl font-bold mt-1 {% if stats.failed_today > 0 %}text-red-400{% else %}text-gray-400{% endif %}">
                    {{ stats.failed_today }}
                </p>
            </div>
            {{ icons.x_mark("w-10 h-10 opacity-50 text-red-400") }}
        </div>
    </div>
    
    <div class="stat-card glass-card rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm">Running Now</p>
                <p class="text-3xl font-bold mt-1 {% if stats.running_now > 0 %}text-blue-400{% endif %}">
                    {{ stats.running_now }}
                </p>
            </div>
            {{ icons.bolt("w-10 h-10 opacity-50 text-yellow-400") }}
        </div>
    </div>
</div>

<!-- Scripts Table -->
<div class="glass-card rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-700/50 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <h3 class="text-lg font-semibold">Scripts</h3>
        <div class="flex items-center gap-3">
            {% if scripts %}
            <input
                id="script-filter"
                type="text"
                class="input input-bordered input-sm w-full sm:w-72"
                placeholder="Filter scriptsâ€¦"
                autocomplete="off"
            />
            {% endif %}
            <a href="/scripts/new" class="btn btn-primary btn-sm gap-2">
                {{ icons.sparkles("w-4 h-4") }} New Script
            </a>
        </div>
    </div>
    
    {% if scripts %}
    <div class="overflow-x-auto">
        <table class="table w-full">
            <thead>
                <tr class="border-b border-gray-700/50">
                    <th class="bg-transparent">Status</th>
                    <th class="bg-transparent">Name</th>
                    <th class="bg-transparent">Schedule</th>
                    <th class="bg-transparent">Last Run</th>
                    <th class="bg-transparent">Next Run</th>
                    <th class="bg-transparent">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in scripts %}
                <tr
                    class="border-b border-gray-700/30 hover:bg-white/5"
                    data-search="{{ (item.script.name ~ ' ' ~ (item.script.description or '') ~ ' ' ~ item.script.cron_expression)|lower }}"
                >
                    <td>
                        {% if item.script.enabled %}
                            {% if item.last_execution %}
                                <span class="status-badge {{ item.last_execution.status }}">
                                    {% if item.last_execution.status == 'running' %}
                                        <span class="pulse-dot"></span>
                                    {% endif %}
                                    {{ item.last_execution.status }}
                                </span>
                            {% else %}
                                <span class="status-badge pending">pending</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-ghost">disabled</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/scripts/{{ item.script.id }}" class="font-medium hover:text-indigo-400 transition-colors">
                           <div class="flex items-center gap-3">
                            <div class="font-bold">{{ item.script.name }}</div>
                            {% if item.script.git_commit %}
                            <div class="badge badge-info badge-outline gap-1 text-[10px] h-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.28 1.15-.28 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
                                git
                            </div>
                            {% endif %}
                        </div>
                        </a>
                        {% if item.script.description %}
                        <p class="text-xs text-gray-500 mt-0.5">{{ item.script.description[:50] }}{% if item.script.description|length > 50 %}...{% endif %}</p>
                        {% endif %}
                    </td>
                    <td>
                        <code class="text-xs bg-gray-800 px-2 py-1 rounded">{{ item.script.cron_expression }}</code>
                    </td>
                    <td>
                        {% if item.last_execution %}
                            <span class="text-sm">{{ item.last_execution.started_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            <span class="text-xs text-gray-500 block">{{ item.last_execution.duration_formatted }}</span>
                        {% else %}
                            <span class="text-gray-500">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.next_run and item.script.enabled %}
                            <span class="text-sm">{{ item.next_run.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% else %}
                            <span class="text-gray-500">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <form action="/scripts/{{ item.script.id }}/run" method="POST" class="inline">
                                <button type="submit" class="btn btn-ghost btn-xs" title="Run now">
                                    {{ icons.play("w-4 h-4") }}
                                </button>
                            </form>
                            <a href="/scripts/{{ item.script.id }}/edit" class="btn btn-ghost btn-xs" title="Edit">
                                {{ icons.pencil("w-4 h-4") }}
                            </a>
                            <form action="/scripts/{{ item.script.id }}/toggle" method="POST" class="inline">
                                <button type="submit" class="btn btn-ghost btn-xs" title="Toggle">
                                    {% if item.script.enabled %}{{ icons.pause("w-4 h-4") }}{% else %}{{ icons.play("w-4 h-4") }}{% endif %}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-12 text-center">
        {{ icons.inbox("w-20 h-20 mb-4 opacity-50 mx-auto") }}
        <h3 class="text-xl font-medium text-gray-400 mb-2">No scripts yet</h3>
        <p class="text-gray-500 mb-6">Create your first script to get started</p>
        <a href="/scripts/new" class="btn btn-primary gap-2">
            {{ icons.sparkles("w-5 h-5") }} Create Script
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(() => {
    const input = document.getElementById('script-filter');
    if (!input) return;

    const storageKey = 'dashboardScriptFilter';
    input.value = localStorage.getItem(storageKey) || '';

    const rows = Array.from(document.querySelectorAll('tbody tr[data-search]'));

    function applyFilter() {
        const q = (input.value || '').trim().toLowerCase();
        for (const row of rows) {
            const haystack = row.dataset.search || '';
            row.style.display = !q || haystack.includes(q) ? '' : 'none';
        }
    }

    input.addEventListener('input', () => {
        localStorage.setItem(storageKey, input.value);
        applyFilter();
    });

    applyFilter();
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% import "icons.html" as icons %}

{% block header_actions %}
<button onclick="openEditModal()" class="btn btn-primary btn-sm gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
    </svg>
    Edit Settings
</button>
{% endblock %}

{% block content %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- General Settings -->
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">General Settings</h3>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">App Name</span>
                <span>{{ settings.app_name }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">Scripts Directory</span>
                <code class="text-xs">{{ settings.scripts_dir }}</code>
            </div>
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">Environments Directory</span>
                <code class="text-xs">{{ settings.envs_dir }}</code>
            </div>
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">Default Timeout</span>
                <span>{{ settings.default_timeout }}s</span>
            </div>
        </div>
    </div>
    
    <!-- Email Settings -->
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Email Alerts</h3>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">SMTP Enabled</span>
                {% if settings.smtp_enabled %}
                    <span class="badge badge-success">Enabled</span>
                {% else %}
                    <span class="badge badge-ghost">Disabled</span>
                {% endif %}
            </div>
            {% if settings.smtp_enabled %}
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">SMTP Host</span>
                <code class="text-xs">{{ settings.smtp_host }}:{{ settings.smtp_port }}</code>
            </div>
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                <span class="text-base-content/60">Alert Email</span>
                <span>{{ settings.alert_email or 'Not configured' }}</span>
            </div>
            <div class="mt-4">
                <button onclick="testEmail()" class="btn btn-sm btn-outline gap-2">
                    {{ icons.envelope("w-4 h-4") }} Send Test Email
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Maintenance & Backups -->
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Backups & Maintenance</h3>
        
        <div class="space-y-4">
            <p class="text-sm text-base-content/60">
                All data is stored in the <code>/data</code> and <code>/scripts</code> volumes. 
                Regular backup of these directories is recommended.
            </p>
            
            <div class="flex flex-col gap-2">
                <a href="/api/settings/download-db" class="btn btn-sm btn-outline gap-2">
                    {{ icons.arrow_down_tray("w-4 h-4") }} Download DB Backup
                </a>
                <button onclick="reloadScheduler()" class="btn btn-sm btn-outline gap-2">
                    {{ icons.arrow_path("w-4 h-4") }} Reload Scheduler Jobs
                </button>
            </div>
        </div>
    </div>
    
    <!-- Artifacts Storage -->
    <div class="glass-card rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            {{ icons.archive_box("w-5 h-5") }} Artifacts Storage
        </h3>
        
        <div class="space-y-4">
            <div id="artifacts-stats" class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                    <span class="text-base-content/60">Total Artifacts</span>
                    <span id="total-artifacts">Loading...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                    <span class="text-base-content/60">Storage Used</span>
                    <span id="storage-used">Loading...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                    <span class="text-base-content/60">Executions with Artifacts</span>
                    <span id="executions-with-artifacts">Loading...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                    <span class="text-base-content/60">Free Disk Space</span>
                    <span id="free-space">Loading...</span>
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="clearAllArtifacts()" class="btn btn-sm btn-outline btn-error gap-2">
                    {{ icons.trash("w-4 h-4") }} Clear All Artifacts
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Settings Modal -->
<dialog id="edit-modal" class="modal">
    <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg mb-4">Edit Settings</h3>
        
        <form id="settings-form" class="space-y-6">
            <!-- Email Settings -->
            <div class="border border-base-300 rounded-lg p-4">
                <h4 class="font-semibold mb-3">Email Alerts</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="form-control">
                        <span class="label-text">SMTP Enabled</span>
                        <input type="checkbox" name="smtp_enabled" class="toggle toggle-primary" {% if settings.smtp_enabled %}checked{% endif %}>
                    </label>
                    <label class="form-control">
                        <span class="label-text">SMTP Host</span>
                        <input type="text" name="smtp_host" value="{{ settings.smtp_host }}" class="input input-bordered input-sm">
                    </label>
                    <label class="form-control">
                        <span class="label-text">SMTP Port</span>
                        <input type="number" name="smtp_port" value="{{ settings.smtp_port }}" class="input input-bordered input-sm">
                    </label>
                    <label class="form-control">
                        <span class="label-text">SMTP User</span>
                        <input type="text" name="smtp_user" value="{{ settings.smtp_user }}" class="input input-bordered input-sm">
                    </label>
                    <label class="form-control">
                        <span class="label-text">SMTP Password</span>
                        <input type="password" name="smtp_password" placeholder="••••••••" class="input input-bordered input-sm">
                    </label>
                    <label class="form-control">
                        <span class="label-text">From Address</span>
                        <input type="email" name="smtp_from" value="{{ settings.smtp_from }}" class="input input-bordered input-sm">
                    </label>
                    <label class="form-control">
                        <span class="label-text">Alert Email</span>
                        <input type="email" name="alert_email" value="{{ settings.alert_email }}" class="input input-bordered input-sm">
                    </label>
                </div>
            </div>
            
            <!-- Execution Settings -->
            <div class="border border-base-300 rounded-lg p-4">
                <h4 class="font-semibold mb-3">Execution</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="form-control">
                        <span class="label-text">Default Timeout (seconds)</span>
                        <input type="number" name="default_timeout" value="{{ settings.default_timeout }}" class="input input-bordered input-sm">
                    </label>
                </div>
            </div>
        </form>
        
        <div class="modal-action">
            <button type="button" onclick="closeEditModal()" class="btn btn-ghost">Cancel</button>
            <button type="button" onclick="saveSettings()" class="btn btn-primary">Save Changes</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_scripts %}
<script>
    // Load artifacts stats on page load
    window.addEventListener('DOMContentLoaded', async () => {
        await loadArtifactsStats();
    });
    
    async function loadArtifactsStats() {
        try {
            const response = await fetch('/api/settings/artifacts-stats');
            const data = await response.json();
            
            document.getElementById('total-artifacts').textContent = data.total_artifacts;
            document.getElementById('storage-used').textContent = `${data.total_size_mb} MB`;
            document.getElementById('executions-with-artifacts').textContent = data.executions_with_artifacts;
            document.getElementById('free-space').textContent = `${data.free_space_mb} MB`;
        } catch (err) {
            console.error('Failed to load artifacts stats:', err);
        }
    }
    
    async function clearAllArtifacts() {
        if (!confirm('Are you sure you want to delete ALL artifacts? This cannot be undone!')) {
            return;
        }
        
        try {
            const response = await fetch('/api/settings/clear-artifacts', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.success) {
                window.showToast?.(data.message, 'success');
                await loadArtifactsStats();
            } else {
                window.showToast?.('Failed to clear artifacts', 'error');
            }
        } catch (err) {
            window.showToast?.(err.message || 'Failed to clear artifacts', 'error');
        }
    }
    
    function openEditModal() {
        document.getElementById('edit-modal').showModal();
    }
    
    function closeEditModal() {
        document.getElementById('edit-modal').close();
    }
    
    async function saveSettings() {
        const form = document.getElementById('settings-form');
        const formData = new FormData(form);
        
        const data = {};
        
        // Checkboxes
        data.smtp_enabled = formData.get('smtp_enabled') === 'on';
        
        // Text fields
        if (formData.get('smtp_host')) data.smtp_host = formData.get('smtp_host');
        if (formData.get('smtp_port')) data.smtp_port = parseInt(formData.get('smtp_port'));
        if (formData.get('smtp_user')) data.smtp_user = formData.get('smtp_user');
        if (formData.get('smtp_password')) data.smtp_password = formData.get('smtp_password');
        if (formData.get('smtp_from')) data.smtp_from = formData.get('smtp_from');
        if (formData.get('alert_email')) data.alert_email = formData.get('alert_email');
        
        if (formData.get('default_timeout')) data.default_timeout = parseInt(formData.get('default_timeout'));
        
        try {
            const response = await fetch('/api/settings/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeEditModal();
                window.showToast?.('Settings saved', 'success');
                setTimeout(() => location.reload(), 2800);
            } else {
                window.showToast?.(result.message || 'Failed to save settings', 'error');
            }
        } catch (err) {
            window.showToast?.(err.message || 'Failed to save settings', 'error');
        }
    }
    
    async function testEmail() {
        try {
            const response = await fetch('/api/settings/test-email', { method: 'POST' });
            const data = await response.json();
            window.showToast?.(data.message || 'Test email sent', data.success ? 'success' : 'warning');
        } catch (err) {
            window.showToast?.(err.message || 'Failed to send test email', 'error');
        }
    }
    
    async function reloadScheduler() {
        try {
            const response = await fetch('/api/settings/reload-scheduler', { method: 'POST' });
            const data = await response.json();
            const msg = (data.message || 'Scheduler reloaded') + (typeof data.job_count === 'number' ? ` (${data.job_count} jobs)` : '');
            window.showToast?.(msg, data.success ? 'success' : 'warning');
            if (data.success) setTimeout(() => location.reload(), 2800);
        } catch (err) {
            window.showToast?.(err.message || 'Failed to reload scheduler', 'error');
        }
    }
</script>
{% endblock %}
